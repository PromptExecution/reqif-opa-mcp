{
  "project": "Ralph Python CLI Tool",
  "branchName": "ralph/python-rewrite",
  "description": "Rewrite ralph.sh from bash into a Python CLI tool using uv, maintaining all current functionality (amp, claude, codex support) while improving maintainability, testability, and following Python best practices.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Python CLI entry point with argument parsing",
      "description": "As a developer, I need a Python CLI tool with proper argument parsing to replace the bash script while maintaining the same interface.",
      "acceptanceCriteria": [
        "Create ralph/ralph_cli.py with click or argparse for CLI",
        "Support --tool {amp,claude,codex} argument (default: amp)",
        "Support positional max_iterations argument (default: 10)",
        "Add --help flag with usage documentation",
        "Add --version flag showing tool version",
        "Typecheck passes with mypy --strict",
        "Follows PEP 484 type hints"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Implement configuration management",
      "description": "As the tool, I need to load configuration from environment variables and defaults to support amp, claude, and codex execution.",
      "acceptanceCriteria": [
        "Create ralph/config.py with typed configuration dataclass",
        "Load CODEX_PROMPT_FILE (default: CLAUDE.md)",
        "Load CODEX_MODEL (default: gpt-5-codex)",
        "Load CODEX_REASONING_EFFORT (default: high)",
        "Load CODEX_SANDBOX (default: workspace-write)",
        "Load CODEX_FULL_AUTO (default: true)",
        "Load CODEX_EXTRA_ARGS (optional)",
        "Use pydantic or dataclasses for validation",
        "Typecheck passes with mypy --strict"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Implement tool execution abstraction",
      "description": "As the CLI, I need to execute amp, claude, and codex tools with proper subprocess handling and output capture.",
      "acceptanceCriteria": [
        "Create ralph/executors.py with ToolExecutor protocol/ABC",
        "Implement AmpExecutor: reads prompt.md, runs amp --dangerously-allow-all",
        "Implement ClaudeExecutor: runs claude --model sonnet --dangerously-skip-permissions --print < CLAUDE.md",
        "Implement CodexExecutor: runs codex exec with all config parameters",
        "Use subprocess.run() with proper error handling",
        "Stream output to stderr using tee-like behavior",
        "Return Result[str, Exception] from dry-python/returns",
        "Typecheck passes with mypy --strict"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Implement PRD and progress file management",
      "description": "As Ralph, I need to manage prd.json and progress.txt files for tracking work and archival.",
      "acceptanceCriteria": [
        "Create ralph/file_manager.py with PRD and progress operations",
        "Implement read_prd() -> Result[Dict[str, Any], Exception]",
        "Implement get_current_branch() -> Option[str] from prd.json",
        "Implement initialize_progress_file() if not exists",
        "Implement append_to_progress(message: str)",
        "Use pathlib.Path for all file operations",
        "Return Result/Option types from dry-python/returns",
        "Typecheck passes with mypy --strict"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Implement branch change detection and archival",
      "description": "As Ralph, I need to detect branch changes and archive previous runs automatically.",
      "acceptanceCriteria": [
        "Create ralph/archiver.py with branch tracking logic",
        "Implement check_branch_change() -> bool",
        "Implement archive_previous_run(last_branch: str, current_branch: str)",
        "Archive to archive/{date}-{branch-name}/ with prd.json and progress.txt",
        "Update .last-branch file with current branch",
        "Reset progress.txt on branch change",
        "Use datetime for timestamps (YYYY-MM-DD format)",
        "Typecheck passes with mypy --strict"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Implement main iteration loop",
      "description": "As Ralph, I need to run the selected tool iteratively and check for completion signals.",
      "acceptanceCriteria": [
        "Create ralph/runner.py with main iteration logic",
        "Implement run_ralph(tool: str, max_iterations: int) -> int",
        "Loop max_iterations times, executing selected tool",
        "Check output for <promise>COMPLETE</promise> signal",
        "Print iteration progress with clear formatting",
        "Sleep 2 seconds between iterations",
        "Return 0 on completion, 1 on max iterations reached",
        "Typecheck passes with mypy --strict"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create uv-based entry point and pyproject.toml",
      "description": "As a user, I need to run ralph as a uv tool with 'uv run ralph' or installed as a CLI.",
      "acceptanceCriteria": [
        "Update pyproject.toml with [project.scripts] entry point: ralph = \"ralph.ralph_cli:main\"",
        "Add dependencies: click (or argparse stdlib), dry-python/returns",
        "Add dev dependencies: mypy, ruff, pytest",
        "Set Python version requirement >=3.11 (for PEP 654)",
        "Configure ruff in pyproject.toml (no black)",
        "Configure mypy strict mode in pyproject.toml",
        "Test with: uv run ralph --help"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Add error handling and logging",
      "description": "As Ralph, I need proper error handling with exceptions and logging for debugging.",
      "acceptanceCriteria": [
        "Use logging module with emoji prefixes (✅, ℹ️, ⚠️, ❌)",
        "Catch subprocess errors and wrap in Result types",
        "Use chained exceptions (raise X from Y) for context",
        "Log configuration at startup (tool, iterations, model)",
        "Log iteration start/end with clear separators",
        "Log errors with full tracebacks to stderr",
        "Typecheck passes with mypy --strict"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Write unit tests for core modules",
      "description": "As a maintainer, I need tests to ensure ralph works correctly and prevent regressions.",
      "acceptanceCriteria": [
        "Create tests/test_ralph_cli.py with pytest tests",
        "Test CLI argument parsing with various inputs",
        "Test configuration loading from env vars",
        "Mock subprocess calls and test executor logic",
        "Test file operations (PRD read, progress write)",
        "Test branch change detection and archival logic",
        "Achieve >80% code coverage",
        "All tests pass with: uv run pytest"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Add integration test with real tool execution",
      "description": "As a maintainer, I need integration tests that verify ralph can actually run tools end-to-end.",
      "acceptanceCriteria": [
        "Create tests/test_ralph_integration.py",
        "Test ralph with --tool amp for 1 iteration (if amp available)",
        "Test ralph with --tool codex for 1 iteration (if codex available)",
        "Verify progress.txt is created and updated",
        "Verify output contains iteration messages",
        "Mark as skipif tool not installed (@pytest.mark.skipif)",
        "Tests pass with: uv run pytest tests/test_ralph_integration.py"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Update justfile with Python ralph commands",
      "description": "As a developer, I need justfile commands to run the Python version of ralph easily.",
      "acceptanceCriteria": [
        "Add justfile command: ralph TOOL='amp' ITERATIONS='10': uv run ralph --tool {{TOOL}} {{ITERATIONS}}",
        "Add justfile command: ralph-test: uv run pytest tests/test_ralph*",
        "Add justfile command: ralph-check: uv run mypy ralph/ && uv run ruff check ralph/",
        "Add justfile command: ralph-format: uv run ruff format ralph/",
        "Update existing justfile commands if needed",
        "Test all commands work correctly"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Update documentation for Python ralph",
      "description": "As a user, I need updated documentation explaining the Python version and migration from bash.",
      "acceptanceCriteria": [
        "Update ralph/README.md with Python usage: uv run ralph --tool codex 10",
        "Document migration from ralph.sh to Python ralph",
        "Add troubleshooting section for common Python issues",
        "Document all environment variables in table format",
        "Add examples for each tool (amp, claude, codex)",
        "Update CLAUDE.md if Ralph workflow changed",
        "Keep bash ralph.sh for backwards compatibility (note deprecation)"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Add type checking and linting to CI",
      "description": "As a maintainer, I need automated type checking and linting to ensure code quality.",
      "acceptanceCriteria": [
        "Update .github/workflows or add new workflow for ralph",
        "Run mypy --strict on ralph/ module",
        "Run ruff check on ralph/ module",
        "Run pytest with coverage reporting",
        "Fail CI if type errors or lint errors found",
        "Add badge to README showing CI status",
        "Verify workflow runs successfully"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    }
  ]
}
